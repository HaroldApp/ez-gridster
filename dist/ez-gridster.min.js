/**
 * @file ez-gridster - 
 * @module ez-gridster
 * 
 * @see 
 * @version 0.4.2
 * @license MIT
 */
!function(a){"use strict";var b=a.module("ez.gridster",[]);b.constant("GridsterConfig",{modes:{desktop:{columns:12,minThreshold:1025,maxThreshold:9999,defaultSizeX:3,defaultSizeY:3,minSizeX:3,minSizeY:2},tablet:{columns:12,minThreshold:768,maxThreshold:1024,defaultSizeX:4,defaultSizeY:4,minSizeX:4,minSizeY:2},mobile:{itemPadding:[0,10],columns:6,minThreshold:0,maxThreshold:767,defaultSizeX:6,defaultSizeY:6,minSizeX:6,minSizeY:3}},width:"auto",colWidth:"auto",rowHeight:"match",padding:[10,10],minItemWidth:100,minItemHeight:100,minRows:"auto",maxRows:1e3,renderDelay:500,trackByProperty:"id",rowProperty:"row",colProperty:"col",sizeXProperty:"sizeX",sizeYProperty:"sizeY",floatItemsUp:!0,moveOverlappingItems:!0,dragEnabled:!0,resizableEnabled:!0,iframeFix:!0,previewEnabled:!0,scrollEdgeEnabled:!0,scrollElSelector:"html,body",gridContainerSelector:"window"}),b.controller("GridsterCtrl",function(b,c,d){var e=this,f=null,g=null;b.itemElements=[],this.init=function(c){if(f=c,g=c[0].querySelector(".gridster-preview-holder"),b.options=a.extend({},d),a.extend(b.options,b.config),this.resolveOptions(),this.getOption("scrollEdgeEnabled")&&!$(".gridster-scroll-edge").length){var e=a.element('<div class="gridster-scroll-edge top-edge"></div>'),h=a.element('<div class="gridster-scroll-edge bottom-edge"></div>');interact.dynamicDrop(!0),this.addScrollEdge(e[0],-200),this.addScrollEdge(h[0],200)}},this.setLoaded=function(){b.options.isLoaded=!0,this.addClass("gridster-loaded"),b.$broadcast("ez-gridster.loaded")},this.getOption=function(a){return b.options.modes[b.options.mode].hasOwnProperty(a)?b.options.modes[b.options.mode][a]:b.options[a]},this.setOption=function(a,c){b.options.modes[b.options.mode].hasOwnProperty(a)?b.options.modes[b.options.mode][a]=c:b.options[a]=c},this.redraw=function(){this.moveAllOverlappingItems(),this.floatItemsUp(),this.updateGridHeight(),this.setElements()},this.addItemElement=function(a,c){b.itemElements[a]=c},this.getItemElement=function(a){return b.itemElements[a]},this.removeItemElement=function(a){delete b.itemElements[a]},this.addClass=function(a){f.addClass(a)},this.removeClass=function(a){f.removeClass(a)},this.resolveOptions=function(a){var c,d,e,g=b.options.mode;e=f[0].offsetWidth;for(var h in b.options.modes)if(c=b.options.modes[h],e>=c.minThreshold&&e<=c.maxThreshold){h!==g&&(b.options.mode=h,this.removeClass("gridster-"+g),this.addClass("gridster-"+h));break}this.getOption("previewEnabled")?this.addClass("gridster-preview-enabled"):this.removeClass("gridster-preview-enabled"),"auto"!==this.getOption("width")&&(b.options.curWidth=this.getOption("width")),e-=2*this.getOption("padding")[0],e!==b.options.curWidth&&(b.options.curWidth=e,d=!0),b.options.curColWidth="auto"===this.getOption("colWidth")?b.options.curWidth/this.getOption("columns"):this.getOption("colWidth"),b.options.curRowHeight="match"===this.getOption("rowHeight")?b.options.curColWidth:this.getOption("rowHeight"),b.options.isLoaded?d&&!a&&b.$broadcast("ez-gridster.updated",b.options):this.addClass("gridster-"+b.options.mode)},this.canItemOccupy=function(a,b,c,d,e){return 0>a||0>b||a+d>this.getOption("maxRows")||b+c>this.getOption("columns")||this.getItemsInArea(a,b,c,d,e).length>0?!1:!0},this.getItemsInArea=function(a,c,d,e,f){var g,h=[];!f||f instanceof Array||(f=[f]);for(var i=0,j=b.items.length;j>i;i++)g=b.items[i],f&&-1!==f.indexOf(g)||!this.isItemHidden(g)&&this.isItemInArea(g,a,c,d,e)&&h.push(g);return h},this.isItemInArea=function(a,b,c,d,e){var f,g,h,i;return f=this.getRow(a),g=this.getCol(a),h=this.getSizeX(a),i=this.getSizeY(a),b>=f+i||f>=b+e||c>=g+h||g>=c+d?!1:!0},this.resolveParam=function(a,b,c){if(a=parseInt(a,10),null===a||isNaN(a)||"number"!=typeof a||0>a){if("undefined"!=typeof b)return this.resolveParam(b,c);if("undefined"!=typeof c)return this.resolveParam(c);a=null}return a},this.fixItem=function(a){var c,d,e,f,g,h,i=b.options.mode,j=this.getOption("defaultSizeX"),k=this.getOption("defaultSizeY");for(c in b.options.modes){if(b.options.mode=c,d=this.resolveParam(this.getSizeX(a),j),d<this.getOption("minSizeX")&&(d=j),a=this.setSizeX(a,d),e=this.resolveParam(this.getSizeY(a),k),e<this.getOption("minSizeY")&&(e=k),a=this.setSizeY(a,e),f=this.getRow(a),g=this.getCol(a),null===f||null===g||f>this.getOption("maxRows")||g>=this.getOption("columns")||this.getItemsInArea(f,g,d,e,a).length>0){if(h=this.getNextPosition(d,e,a),h===!1&&(a=this.setSizeX(a,j),a=this.setSizeY(a,k),h=this.getNextPosition(null,null,a),h===!1))throw new Error("No positions available");f=h.row,g=h.col}a=this.setRow(a,f),a=this.setCol(a,g)}b.options.mode=i,this.getOption("floatItemsUp")&&this.floatItemUp(a,!0)},this.getNextPosition=function(a,b,c){a=a||this.getOption("defaultSizeX"),b=b||this.getOption("defaultSizeY");for(var d=0,e=this.getOption("maxRows");e>=d;d++)for(var f=0,g=this.getOption("columns");g>f;f++)if(this.canItemOccupy(d,f,a,b,c))return{row:d,col:f};return!1},this.moveOverlappingItems=function(a,b){if(this.getOption("moveOverlappingItems")!==!1&&!this.isItemHidden(a)){var c,d,e,f,g,h,i,j,k;d=this.getRow(a),e=this.getCol(a),f=this.getSizeX(a),g=this.getSizeY(a),c=this.getItemsInArea(d,e,f,g,a);for(var l=0,m=c.length;m>l;l++)h=this.getRow(c[l]),i=this.getCol(c[l]),j=this.getSizeX(c[l]),k=this.getSizeY(c[l]),c[l]=b===!0&&d>0&&this.canItemOccupy(h-(g+k-1),i,j,k,c[l])?this.setRow(c[l],h-(g+k-1)):this.setRow(c[l],d+g),this.translateElementPosition(this.getItemElement(c[l][this.getOption("trackByProperty")]),this.colToPixels(this.getCol(c[l])),this.rowToPixels(this.getRow(c[l]))),this.moveOverlappingItems(c[l],!1,!0)}},this.moveAllOverlappingItems=function(){if(0!==b.items.length)for(var a=0,c=b.items.length;c>a;a++)this.moveOverlappingItems(b.items[a])},this.floatItemsUp=function(){if(this.getOption("floatItemsUp")!==!1&&b.items){for(var a=!1,c=0;c<b.items.length;c++)this.floatItemUp(b.items[c])&&(a=!0);a&&this.floatItemsUp()}},this.floatItemUp=function(a,b){var c,d,e,f,g,h=null;for(d=this.getRow(a)-1,e=this.getCol(a),f=this.getSizeX(a),g=this.getSizeY(a);d>-1&&(c=this.getItemsInArea(d,e,f,g,a),0===c.length);)h=d,--d;return null!==h?(a=this.setRow(a,h),b||this.translateElementPosition(this.getItemElement(a[this.getOption("trackByProperty")]),this.colToPixels(e),this.rowToPixels(h)),!0):!1},this.updateGridHeight=function(a){var c,d=0,e=this.getOption("minRows"),g=0;if(d="auto"===e?this.getOption("defaultSizeY"):e,b.items)for(var h=0;h<b.items.length;h++)c=this.getRow(b.items[h])+this.getSizeY(b.items[h]),c>d&&(d=c);a&&(d+=this.getSizeY(a)),d>this.getOption("maxRows")&&(d=this.getOption("maxRows")),g=d*this.getOption("curRowHeight")+2*this.getOption("padding")[1],f.height(g)},this.pixelsToRows=function(a,b){var c;return(!a||0>a)&&(a=0),c=b===!0?Math.ceil(a/this.getOption("curRowHeight")):b===!1?Math.floor(a/this.getOption("curRowHeight")):Math.round(a/this.getOption("curRowHeight"))},this.pixelsToColumns=function(a,c){var d;return(!a||0>a)&&(a=0),d=c===!0?Math.ceil(a/b.options.curColWidth):c===!1?Math.floor(a/b.options.curColWidth):Math.round(a/b.options.curColWidth)},this.rowToPixels=function(a){return a*b.options.curRowHeight+2*this.getOption("padding")[1]},this.colToPixels=function(a){return a*b.options.curColWidth+2*this.getOption("padding")[0]},this.translateElementPosition=function(a,b,c){var d;if(null===a){if(!this.getOption("previewEnabled"))return;a=g}d=Modernizr.csstransforms3d?"translate3d("+b+"px,"+c+"px, 0)":"translate("+b+"px,"+c+"px)",a.style.webkitTransform=d,a.style.MozTransform=d,a.style.OTransform=d,a.style.msTransform=d,a.style.transform=d},this.setElementHeight=function(a,b){if(null===a){if(!this.getOption("previewEnabled"))return;a=g}b=b-4*this.getOption("padding")[1]+"px",a.style.height=b},this.setElementWidth=function(a,b){if(null===a){if(!this.getOption("previewEnabled"))return;a=g}b=b-4*this.getOption("padding")[0]+"px",a.style.width=b},this.setElement=function(a,b,c){if(null===a){if(!this.getOption("previewEnabled"))return;a=g}else{if(this.isItemHidden(b))return void(a.style.display="none");a.style.display="block"}this.translateElementPosition(a,this.colToPixels(this.getCol(b)),this.rowToPixels(this.getRow(b))),c||(this.setElementWidth(a,this.colToPixels(this.getSizeX(b))),this.setElementHeight(a,this.rowToPixels(this.getSizeY(b))))},this.setElements=function(){for(var a=0;a<b.items.length;a++)this.setElement(this.getItemElement(b.items[a][this.getOption("trackByProperty")]),b.items[a])},this.hasItemPositionChanged=function(a,b,c){return this.getRow(a)!==b||this.getCol(a)!==c?!0:!1},this.hasItemWidthChanged=function(a,b){return this.getSizeX(a)!==b?!0:!1},this.hasItemHeightChanged=function(a,b){return this.getSizeY(a)!==b?!0:!1},this.getItemProperty=function(a,c){return a.hasOwnProperty(b.options.mode)?(a[b.options.mode].hasOwnProperty(c)||(a[b.options.mode][c]=null),a[b.options.mode][c]):null},this.setItemProperty=function(a,c,d){return a.hasOwnProperty(b.options.mode)||(a[b.options.mode]={}),a[b.options.mode][c]=d,a},this.getRow=function(a){return this.getItemProperty(a,b.options.rowProperty)},this.setRow=function(a,c){return this.setItemProperty(a,b.options.rowProperty,c)},this.getCol=function(a){return this.getItemProperty(a,b.options.colProperty)},this.setCol=function(a,c){var d=this.getSizeX(a);return c+d>this.getOption("columns")&&(c=this.getOption("columns")-d),this.setItemProperty(a,b.options.colProperty,c)},this.getSizeX=function(a){return this.getItemProperty(a,b.options.sizeXProperty)},this.setSizeX=function(a,c){var d=this.getOption("minSizeX");d>c&&(c=d);var e=this.getOption("columns")-a[this.getOption("colProperty")];return c>e&&(c=e),this.setItemProperty(a,b.options.sizeXProperty,c)},this.getSizeY=function(a){return this.getItemProperty(a,b.options.sizeYProperty)},this.setSizeY=function(a,c){var d=this.getOption("minSizeY");d>c&&(c=d);var e=this.getOption("maxRows")-a[this.getOption("rowProperty")];return c>e&&(c=e),this.setItemProperty(a,b.options.sizeYProperty,c)},this.isItemHidden=function(a){return a.hasOwnProperty(b.options.mode)?a[b.options.mode].hidden:!1},this.getPosition=function(a){var b,c,d,e=$(a),f=e.css("-webkit-transform")||e.css("-moz-transform")||e.css("-ms-transform")||e.css("-o-transform")||e.css("transform");if("string"!=typeof f||"none"===f)throw new Error("Your browser does not support css transforms");return b=f.split("(")[1].split(")")[0].split(","),b.length<4?(d=parseInt(b[0].replace("px",""),10),c=parseInt(b[1].replace("px",""),10)):(d=parseInt(b[4].replace("px",""),10),c=parseInt(b[5].replace("px",""),10)),{left:d,top:c}},this.addScrollEdge=function(a,b){var c=null;interact(a).dropzone({acceptClass:".gridster-item-moving",overlap:"center",ondropmove:function(){if(null===c){var a=$("body").scrollTop();if(0>b&&0>=a)return;c=!0,$(e.getOption("scrollElSelector")).animate({scrollTop:a+b},400),b>0&&f.height(f.height()+b),setTimeout(function(){c=null},400)}}}),$("body").append(a)}}),b.directive("gridster",["$window","$timeout",function(b,c){return{restrict:"EA",controller:"GridsterCtrl",scope:{items:"=",config:"=?gridster",api:"=?"},templateUrl:"ez-gridster-tpl.html",replace:!0,transclude:!0,link:function(d,e,f,g){function h(a){a.target===b&&(i&&c.cancel(i),i=c(j,200))}var i=null;d.api={redraw:function(){g.redraw()},getNextPosition:function(a,b){return g.getNextPosition(a,b)},getOption:function(a){return d.options[a]},setOption:function(a,b){d.options[a]=b}};var j=function(){console.log("rezzz"),g.resolveOptions(),i=null};a.element(b).bind("resize",h),d.$on("$destroy",function(){a.element(b).unbind("resize",h)}),g.init(e)}}}]),b.directive("gridsterItem",["$timeout","$parse",function(b,c){return{restrict:"A",require:"^gridster",replace:!0,scope:{item:"=gridsterItem"},link:function(d,e,f,g){function h(b){var d=z.attr(b);if(d){var e=c(A[z.attr(b)]);if("function"==typeof e)return e}return a.noop}function i(){g.setElementWidth(y,r),g.setElementHeight(y,s),e.addClass("gridster-item-loaded"),H({item:d.item,element:e,size:{width:r,height:s},position:{left:q,top:p}})}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=e[0],z=e.children(0).children(0),A=z.scope(),B=h("on-drag-start"),C=h("on-drag-move"),D=h("on-drag-end"),E=h("on-resize-start"),F=h("on-resize-move"),G=h("on-resize-end"),H=h("on-init"),I=h("on-update"),J=null,K="drag";if(J=interact(y).draggable({manualStart:interact.supportsTouch(),dynamicDrop:!0,onstart:function(a){if(g.addClass("gridster-moving"),e.addClass("gridster-item-moving"),d.item._moving=!0,j=!1,g.updateGridHeight(d.item),g.resolveOptions(),l=g.getRow(d.item),m=g.getCol(d.item),n=g.getSizeX(d.item),o=g.getSizeY(d.item),g.setElement(null,d.item),"drag"===K){if(!g.getOption("dragEnabled"))return;x=g.getOption("columns"),q=g.colToPixels(g.getCol(d.item)),p=g.rowToPixels(g.getRow(d.item)),B({event:a,item:d.item,element:e,position:{top:p,left:q}})}else r=y.offsetWidth,s=y.offsetHeight,k=g.getOption("padding"),t=g.getOption("minSizeX")*g.getOption("curColWidth")-2*k[0],u=(g.getOption("columns")-m)*g.getOption("curColWidth")-2*k[0],v=g.getOption("minSizeY")*g.getOption("curRowHeight")-2*k[1],w=(g.getOption("maxRows")-l)*g.getOption("curColHeight")-2*k[1],E({event:a,item:d.item,element:e,size:{width:r,height:s}})},onmove:function(a){if("drag"===K){if(q+=a.dx,p+=a.dy,!g.getOption("dragEnabled"))return;if(g.translateElementPosition(y,q,p),l=g.pixelsToRows(p),m=g.pixelsToColumns(q),m+n>=x&&(m=x-n),!g.hasItemPositionChanged(d.item,l,m))return;j=!0,d.item=g.setRow(d.item,l),d.item=g.setCol(d.item,m),g.translateElementPosition(null,g.colToPixels(m),g.rowToPixels(l)),C({event:a,item:d.item,element:e,position:{top:p,left:q}})}else{if(r+=a.dx,s+=a.dy,r>u?r=u:t>r&&(r=t),s>w?s=w:v>s&&(s=v),y.style.width=r+"px",y.style.height=s+"px",n=g.pixelsToColumns(r,!0),o=g.pixelsToRows(s,!0),!g.hasItemWidthChanged(d.item,n)&&!g.hasItemHeightChanged(d.item,o))return;j=!0,d.item=g.setSizeX(d.item,n),d.item=g.setSizeY(d.item,o),g.setElement(null,d.item),F({event:a,item:d.item,element:e,size:{width:r,height:s}})}g.moveOverlappingItems(d.item,!0),g.updateGridHeight(d.item)},onend:function(a){if(delete d.item._moving,g.removeClass("gridster-moving"),e.removeClass("gridster-item-moving"),"drag"===K){if(!g.getOption("dragEnabled"))return;g.translateElementPosition(y,g.colToPixels(m),g.rowToPixels(l)),D({event:a,item:d.item,element:e,position:{top:p,left:q}})}else g.setElement(y,d.item),G({event:a,item:d.item,element:e,size:{width:r,height:s}});K="drag",g.floatItemsUp(),g.updateGridHeight(),setTimeout(function(){g.resolveOptions()},500),I({event:a,item:d.item,element:e}),j&&d.$emit("ez-gridster.changed")}}).on("hold",function(a){if(interact.supportsTouch()){var b=a.interaction;b.interacting()||b.start({name:"drag"},a.interactable,a.currentTarget)}}),g.getOption("resizableEnabled")){var L=interact.supportsTouch()?"touchstart":"mousedown";e.find(".resize-handle").bind(L,function(){K="resize"})}if(d.$on("ez-gridster.updated",function(){g.setElement(y,d.item),g.getOption("isLoaded")&&!d.item._moving&&(I({item:d.item,element:e}),d.$emit("ez-gridster.changed"))}),d.$on("$destroy",function(){g.removeItemElement(d.item[g.getOption("trackByProperty")]),null!==J&&(J.unset(),J=null),g.floatItemsUp(),g.updateGridHeight()}),g.fixItem(d.item),q=g.colToPixels(g.getCol(d.item)),p=g.rowToPixels(g.getRow(d.item)),r=g.colToPixels(g.getSizeX(d.item)),s=g.rowToPixels(g.getSizeY(d.item)),g.translateElementPosition(y,q,p),g.addItemElement(d.item[g.getOption("trackByProperty")],y),g.getOption("isLoaded"))g.updateGridHeight(),setTimeout(function(){i()},100),setTimeout(function(){g.resolveOptions()},500);else if(d.$on("ez-gridster.loaded",function(){i()}),d.$parent.$last){g.updateGridHeight();var M=g.getOption("renderDelay");setTimeout(function(){g.setLoaded()},M),b(function(){g.resolveOptions(!0),g.updateGridHeight()},M+500)}}}}]),b.directive("inject",function(){return{link:function(a,b,c,d,e){var f=a.$new();e(f,function(a){b.empty(),b.append(a),b.on("$destroy",function(){f.$destroy()})})}}})}(angular);